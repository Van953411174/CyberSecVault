# Windows - Event Logs
#Windows Event Logs are not text files but raw data that can be translated into XML using the Windows API.  The events stored in these log files are stored in a proprietary binary format with a *.evt* or *.evtx* extension, the latter typically residing in `C:\Windows\System32\winevt\Logs`
## Enabling some Features
**Note**: Some events will not be generated by default, and certain features will need to be enabled/configured on the endpoint, such as **PowerShell logging** . 
### PowerShell Logging
This feature can be enabled via **Group Policy** or the **Registry**.

*Local Computer Policy -> Computer Configuration -> Administrative Templates -> Windows PowerShell*

Some resources to provide more information about enabling this feature, along with its associated event IDs:

-   [About Logging Windows](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging_windows?view=powershell-7.1)
-   [Greater Visibility Through PowerShell Logging](https://www.fireeye.com/blog/threat-research/2016/02/greater_visibilityt.html)
-   [Configure PowerShell logging to see PowerShell anomalies in Splunk UBA](https://docs.splunk.com/Documentation/UBA/5.0.4/GetDataIn/AddPowerShell)

### Audit Process Creation
Detailed docs on feature: https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/manage/component-updates/command-line-process-auditing#try-this-explore-command-line-process-auditing

Another feature to enable/configure is **Audit Process Creation**, which will generate **event ID 4688**. This will enable **command-line process auditing**. This setting is NOT enabled in the virtual machine but feel free to enable it and observe the events generated after executing some commands.

*Local Computer Policy -> Computer Configuration -> Administrative Templates -> System -> Audit Process Creation*


## Types of Events and Logs
### Events
There are [5 types](https://docs.microsoft.com/en-us/windows/win32/eventlog/event-types) of events that can be logged. Brief table follow with expanded descriptions in link. 

| Event Types   | Description                                           |
| ------------- | ----------------------------------------------------- |
| Error         | significant problem such as loss of data/functionality |
| Warning       | not significant but could cause future problems       |
| Information   | successful operation of app/driver/service            |
| Success Audit | successful security access                            |
| Failure Audit | failed security access                                                      |

#### Event IDs
There are **LOTS** of event IDs. As such knowing *what* IDs matter to you is half the battle to finding a needle in a haystack indicating a breach #blue_team, in fact [[ATT&CK Framework]] lists event IDs well. 



- [Spotting the Adversary w/ Windows Event Log Monitoring](https://apps.nsa.gov/iaarchive/library/reports/spotting-the-adversary-with-windows-event-log-monitoring.cfm)
-    [Windows Logging Cheat Sheet ver Oct 2016](https://static1.squarespace.com/static/552092d5e4b0661088167e5c/t/580595db9f745688bc7477f6/1476761074992/Windows+Logging+Cheat+Sheet_ver_Oct_2016.pdf)
-   [Events to Monitor](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor) (Best Practices for Securing Active Directory)
-   [The Windows 10 and Windows Server 2016 Security Auditing and Monitoring Reference](https://www.microsoft.com/en-us/download/confirmation.aspx?id=52630) (a comprehensive list \[**over 700 pages**\])



### Logs
There are [4 types](https://docs.microsoft.com/en-us/windows/win32/eventlog/eventlog-key) of Windows Logs. As above, brief table follows:

| Log Type     | Description                                                                                                                     |
| ------------ | ------------------------------------------------------------------------------------------------------------------------------- |
| Application  | Events logged by applications                                                                                                   |
| Security     | Events such as valid/invalid login attempts, as well a events related to resource use (creating/opening/deleting files or objs) |
| System       | Events logged by system components, such as the failure of a driver or other system component                                   |
| *Custom Log* | Events logged by applications that create a custom logs                                                                                                                                |

For example, #PowerShell (an application), will log operations from the engine, providers, and cmdlets to the Windows event log. 

## Methods of Access
Three Main ways of accessing event logs within a Windows system:
1.  **Event Viewer** (GUI-based application)
2.  **Wevtutil.exe** (command-line tool)
3.  **Get-WinEvent** (PowerShell cmdlet)

Other utils:
- **XPath Queries** (filtering)


### Event Viewer
An #MMC (Microsoft Management Console) snap-in, Event View can be launched by simply right clicking the Windows Icon in the taskbar and selecting `Event Viewer`

Also can be launched from CLI with `eventvwr.msc`

Like Registry Editor, you have to manually drill down to get to anything. 

**Layout**
1. Left pane - hierarchical tree listing of event log providers
2. Middle Pane - general overview/summary or events specific to a selected provider
3. Right Pane - actions

#### Middle Pane 
A brief explanation for each column for events specific to provider:
-   The first column is **Level**, which is the event type. Recall from earlier there are 5 different event types. This first entry is labeled as **Information**.
-   Next is **Date and Time**, which is when the event was logged.
-   The third column **Source** is the name of the software that logs the event. From the above image, the source is PowerShell.
-   Events are identified by IDs (**Event ID**), which is the fourth column. Note that Event IDs are not unique. Meaning that Event ID 4103 in the above image is related to Executing Pipeline but will have an entirely different meaning in another event log.
-   Lastly is **Task Category**, which is an Event Category. This entry will help you organize events so Event Viewer can filter them. The event source defines this column.

More information is displayed in the split pane as the bottom of the middle pane:
This section has 2 tabs: **General** and **Details**.
-   General is the default view, and the rendered data is displayed.
-   The Details view has 2 options: Friendly view and XML view.

#### Right Pane - Actions
Most useful
- Create Custom View
- Filter Current Log

Basically identical but the latter, as the name implied *only* affects the current log while the former *Create Custom View* affects the global view. 

### wetvutil.exe
Microsoft docs: https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/wevtutil
Enables you to retrieve information about event logs and publishers. You can also use this command to install and uninstall event manifests, to run queries, and to export, archive, and clear logs.

To pass a path to a log file to a subcommand, use the following format
`wevtutil <subcmd> <PATH-to-log> /lf:true`
Usage
![[wevtutil_exe-usage.png]]
Usage sub commands
![[wevtutil_exe-usage-commands.png]]
Some common options (many more)
![[wevtutil_exe-common-options.png]]

[[wevutil-security-queries.png]]


### Get-WinEvent
Docs: https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-5.1

A PowerShell cmdlet that "gets events from event logs and event tracing log files on local and remote computers"
- *Get-WinEvent replaces Get-EventLog*

#### Use
##### General Filtering (but inefficient for large event logs)
```powershell
Get-WinEvent -LogName Application | Where-Object { $_.ProviderName - Match 'WLMS}'
```

When working with large event logs its inefficient to send objects down the pipeline to a `Where-Object` command. Instead use the *FilterHashtable* parameter.
##### Filter with Hashtables**
```powershell
Get-WinEvent -FilterHashtable @{ LogName = 'Application'; ProviderName='WLMS'}
```
Syntax of hash table is:
![[powershell-get_winevent-filterhashtable-syntax.png]]
*NOTE: You don't need a semicolon if each key/value pair is on a new line*
###### Hashtables
Guidelines for defining a hashtable:
- Begin the hash table with an at sign (@)
- Enclose the hash table in braces ({})
- Enter one or more key/alue pairs for the context of the hash table
- Use an equal sign (=) to separate each key from its value

| Key name       | Value data type | Accepts wildcard characters? |
| -------------- | --------------- | ---------------------------- |
| LogName        | `<String[]>`    | Yes                          |
| ProviderName   | `<String[]>`    | Yes                          |
| Path           | `<String[]>`    | No                           |
| Keywords       | `<Long[]>`      | No                           |
| ID             | `<Int32[]>`     | No                           |
| Level          | `<Int32[]>`     | No                           |
| StartTime      | `<DateTime>`    | No                           |
| EndTime        | `<DateTime>`    | No                           |
| UserID         | `<SID>`         | No                           |
| Data           | `<String[]>`    | No                           |
| `<named-data>` | `<String[]>`    | No                           |

The `<named-data>` key represents a named event data field.

**NOTE**: some values might require specific entries to be valid, for example *Level* takes a Int32[], but unless you dig you wouldn't know that these don't correlate to the *Level ID* for Information (80) and others. See [here](http://msdn.microsoft.com/en-us/library/system.diagnostics.eventing.reader.standardeventlevel(v=vs.110).aspx) for the requisite values
###### Building Query
The information you need to build a query can be found in Event Viewer

![[event-viewer-hashtable-query-info.png]]

#### Example Queries
See the docs for good starting point examples: [Get-WinEvent Examples](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-5.1#examples)

*Example of FIlterHashtable query*
```powershell
Get-WinEvent -FilterHashtable @{LogName='Microsoft-Windows-PowerShell/Operational'; ID=4104} | Select-Object -Property Message | Select-String -Pattern 'SecureString'
```

### XPath Query
#XPath, or #XML Path Language, supported by Windows Event Logs, at least a subset is ([XPath 1.0](https://www.w3.org/TR/1999/REC-xpath-19991116/). 

Both *wevtutil* and *GetWinEvent* support XPath queries as event filters

#### Constructing Query
An XPath event query starts with `*` or `Event`, and its best practice to explicitly use a keyword following the top-lvl, but can be substituted with `*` like with Event.
- `'*/System'` or `*/*`

Using the Event Viewer, you can select an event, then in the bottom split pane select *Details* an *XML View*. This will show the structure of the event in XML and assist in query creation. 

![[event-viewer-details-xml-view.png]]

##### Event ID Query
Building the query just involves understanding XML and stepping through the structure. From the ==highlighted== portions in the image, you can see the important points for constructing a basic query for an event ID. 
![[event-viewer-xpath-query-eventid.png]]

Using *Event*, *System*, and *EventID=326* we can construct and XPath query for Get-WinEvent
```powershell
Get-WinEvent -LogName Application -FilterXPath 'Event/System/EventID=326'

// The following using '*' is also valid
Get-WinEvent -LogName Application -FilterXPath '*/*/EventID=326'
```

##### Provider Name Query
Different elements might require slightly different query syntax. For example `Provider Name` will require using the `Name` attribute of the provider. 
![[event-viewer-xpath-query-providername.png]]

The format for the XPath query would be:
```powershell
Get-WinEvent -LogName Application -FilterXPath '*/System/Provider[@Name="ESENT"]'
```

##### EventData Query
*NOTE: The `EventData` element doesn't always contain information*
Like before, the syntax is slightly different than the previous two queries. 

![[event-viewer-xpath-query-eventdata.png]]

Using the information, we'll build a query for `TargetUserName`.
The query would be:
```powershell
Get-WinEvent -LogName Security -FilterXPath '*/EventData/Data[@Name="TargetUserName"]="System"'
```



##### Combining Multiple Queries
You can also combine queries using the keyword `and` as long as the entire query is wrapped in `''`

Example using the Above **Event ID** and **Provider Name** queries:
```powershell
Get-WinEvent -LogName Application -FilterXPath '*/System/EventID=326 and */System/Provider[@Name="ESENT"]'
```

#### Example  XPath Queries in Get-WinEvent
Example finding `WLMS` events with System Time `2020-12-15T01:09:08.940277500Z`
```powershell
Get-WinEvent -LogName Application -FilterXPath '*/System/Provider[@Name="WLMS"] and */System/TimeCreated[@SystemTime="2020-12-15T01:09:08.940277500Z"]'
```

Example find user name `Sam` with `Logon Event ID` of `4720`
```powershell
Get-WinEvent -LogName Security -FilterXPath '*/System/EventID=4720 and */EventData/Data[@Name="TargetUserName"]="sam"'
```

