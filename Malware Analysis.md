# Malware Analysis
https://blog.cmnatic.co.uk/posts/so-you-want-to-analyse-malware/
Repo of LIVE malware: https://github.com/ytisf/theZoo


Thankfully, though exceptions do exist, malware by and large is obtrusive and thus leaves artifacts on the system.

When conducting #malware analysis, it is important to consider the following:
- **Point of Entry** (PoE)
	- E.g. Was it through spam that e-mail filtering missed?
- What are the **indicators** that malware has even been executed on a machine?
	- I.e Are there any files, processes , or perhaps any attempt of "un-ordinary" communication?
- How does the **malware perform**?
	- Does it attempt to infect other devices?
	- Does it encrypt files or instally anything like a backdoor / Remote Access Tool (RAT)
- Can we ultimately **prevent and/or detect** further infections

## Process Of Malware Attack
These steps generate a lot of data and artifacts (network traffic, registry entries, log entries, file mods, permission mods, etc). 

Malware is essentially classified based upon the behaviors it produces to perform the steps. 

1. **Delivery**
	1. Email Attachments? USB? Vuln enumeration? 
2. **Execution**
	1. Main part of how malware is classified, only understood by **analyzing** the sample. 
	2. What does it actually *do*?
		1. Encrypt files -> Ransomware
		2. Record keystrokes -> Spyware
		3. Display Ads -> Adware (can be included in spyware)
3. **Persistence and Maintaining it** (not always)
	1. Largely why malware is noisy, as it employs many techniques to make sure that *execution* was worth while. 
	2. Unless the malware has a very specific agenda (like [Cerber](https://blog.malwarebytes.com/detections/ransom-cerber/)), persistence is normally a part of the attack process. 
4. **Propagation** (not always)
	1. Another reason why malware can be so noticeable, since if you can infect one target why not infect others? Host discovery generates a lot of network traffic. 

## Fingerprints
In general there are two categories of fingerprints that malware may leave behind on a host after an attack
### Host-Based Signatures
Generally speaking the results of execution and persistence actions performed by the malware. 
E.g. Has any add. software been installed? Has a file been encrypted or a directory created? 
### Network-Based Signatures
Observation of any networking communication taking place during delivery, execution, and propagation. 
Ex: In Ransomware, where has the malware contacted for bitcoin payments?
Ex. [[ZeroLogon]] abuses MS-NRPC and is characterized by RPC and DCERPC traffic, and if [[SecretsDump.py]] is utilized then also DRSUAPI and SMB 

## Analysis Types
There are two categories used when analyzing malware. 
### Static Analysis
[[Static Analysis]]
Used to gain a high-lvl abstraction of the sample. At its core this method analyzes a sample at the state it presents itself without executing the code.

General tool types:
- static code analysis
- disassemblers
- unpackers/deobfuscation
- string analysis
- signature analysis

Consists of:
- signature analysis via checksums 
- strings extrapolation
- file entropy analysis

### Dynamic Analysis
[[Dynamic Analysis]]
Involve executing the sample and observing what happens. This is **NOT SAFE**. For example is the sample is ransomware, now your files are lost. If it propagates via networks, now your LAN is compromised. 

General tool types:
- debuggers

## Obfuscation
While there are legitimate reasons for obfuscation (such as protecting proprietary information), malware is frequently obfuscated to prevent or hinder analysis. 
- [[PE Explorer]]
- [[PeID]]

### Packing
One form of obfuscation is packing (see MITRE entry on [Software Packing](https://attack.mitre.org/techniques/T1027/002/), that is the compressing or encryption of an executable/code to conceal the code. 





## Sandboxing (Local/Online)
Sandboxing can be accomplished a number of different ways to varying degrees. A common sandboxing technique is the usage of Virtual Machines on a hypervisor, for example VirtualBox, to isolate the system and processes from host OS.

### Online
Services:
- https://any.run/
- https://hybrid-analysis.com/

Online sandboxes for malware analysis provide automated analysis (see [[Malware Analysis#Automated Analysis]]) w/o any risk to the user since they're not executing the malware. Its a great way to offload risk. They also allow for auto checking signatures against databases for known malware. 

## Automated Analysis
Automated analysis is a great way to perform a percursory examination of a sample to assist in more detailed analysis later. 

Automated analysis by no means is as thorough as manual, it can expedite the overall process significantly by cataloging behavior such as:
- domains contacted
- registry keys created/edited 
- read/writing files
- creating system processes
- maintaining persistence through system startup entries


## Analysis of ...
### Malicious PDFs
PDFs are a very common form of delivery for malware as they're often attached in emails or available on websites, and allow for code embedding. 
PDFs can contains:
- Javascript
- Python
- Executables
- Powershell Shellcode

See [[peepdf]] for example analysis and usage.

Tools:
- [[peepdf]]

### Malicious Microsoft Office Macros
Malware infection via malicious macros, i.e. scripts w/i Office products like Word/Excel, are some of the most successful attacks to date. 

Malware #Emotet and #QuickBot both infect users with seemingly legit documents attached to emails, that once opened execute malicious code. 

This malicious code is often used in "dropper attacks" where the macro calls out and downloads add. programs onto the host. 

Malicious Macros are often embedded via [[ADS- Alternate Data Streams]]. 

Tools:
- [[vmonkey]] parser engine capable of simple visual basic macro analysis w/o executing (opening the document)

## Future Reading
[A Meaningful MD5 Hash Collision Attack](https://scholarworks.sjsu.edu/cgi/viewcontent.cgi?referer=https://www.google.com/&httpsredir=1&article=1020&context=etd_projects) - (Narayana D. Kashyap., 2008)

[Cryptography & Network Security](https://dl.acm.org/doi/book/10.5555/1209579) - (Behrouz A. Forozuan., 2007)

[The first collision for full SHA-1](https://shattered.io/static/shattered.pdf) - (Stevens et al., 2017) / (Shattered.io)

